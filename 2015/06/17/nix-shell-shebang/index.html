<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>nix-shell and Shebang Lines &#8211; I am Travis</title>
<meta name="description" content="Using nix-shell to write scripts.">
<meta name="keywords" content="Technically Travis">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://iam.travishartwell.net/images/">
<meta name="twitter:title" content="nix-shell and Shebang Lines">
<meta name="twitter:description" content="Using nix-shell to write scripts.">
<meta name="twitter:creator" content="@travisbhartwell">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="nix-shell and Shebang Lines">
<meta property="og:description" content="Using nix-shell to write scripts.">
<meta property="og:url" content="http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/">
<meta property="og:site_name" content="I am Travis">

<meta name="google-site-verification" content="WmaLXA_7GzOWYRF_aJcdtjukq4VdmHE9EJlzVDOFGTc">
<meta name="msvalidate.01" content="C445B4E265CC0E3E4ABAA52E3B998CD3">


<link rel="canonical" href="http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/">
<link href="http://iam.travishartwell.net/feed.xml" type="application/atom+xml" rel="alternate" title="I am Travis Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://iam.travishartwell.net/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://iam.travishartwell.net/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://iam.travishartwell.net/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://iam.travishartwell.net/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://iam.travishartwell.net/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://iam.travishartwell.net/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://iam.travishartwell.net/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://iam.travishartwell.net/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://iam.travishartwell.net/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://iam.travishartwell.net/images/avatar.jpg" alt="Travis B. Hartwell photo" class="author-photo">
					<h4>Travis B. Hartwell</h4>
					<p>LDS. Meditator. Kidney transplant recipient. On dialysis. Losing vision to Retinitis Pigmentosa. Software Toolsmith. Free/Open Source advocate. Writer. Friend.</p>
				</li>
				<li><a href="http://iam.travishartwell.net/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:nafai@travishartwell.net"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/travisbhartwell"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://facebook.com/travisbhartwell"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				<li>
					<a href="https://google.com/+TravisBHartwell"><i class="fa fa-fw fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="http://linkedin.com/in/travisbhartwell"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/travisbhartwell"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				<li>
					<a href="http://gitlab.com/travisbhartwell"><i class="fa fa-fw fa-git"></i> GitLab</a>
				</li>
				<li>
					<a href="http://stackexchange.com/users/6460/travis-b-hartwell"><i class="fa fa-fw fa-stack-exchange"></i> Stackexchange</a>
				</li>
				<li>
					<a href="http://instagram.com/travisbhartwell"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://iam.travishartwell.net/posts/">All Posts</a></li>
				<li><a href="http://iam.travishartwell.net/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/" rel="bookmark" title="nix-shell and Shebang Lines">nix-shell and Shebang Lines</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2015-06-17T08:00:00-06:00">Wednesday, June 17, 2015 at 08:00:00 AM</time></span></h2>
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>A few days ago, version 1.9 of the Nix package manager
<a href="https://nixos.org/releases/nix/nix-1.9/manual/#ssec-relnotes-1.9">was released</a>.
From the release notes:</p>

<blockquote>
  <p>nix-shell can now be used as a #!-interpreter. This allows you to write scripts that dynamically fetch their own dependencies.</p>
</blockquote>

<p>They followed with an example that used GHC’s <code>runhaskell</code> to execute Haskell
code using libraries that had been specified in the shebang line.
Unfortunately, this specific example doesn’t work, as it isn’t sufficient
information for Haskell to find the Network.HTTP library.</p>

<p>But this notwithstanding, it is still an interesting change that I have found
useful.  To use it, start your scripts with two lines similar to this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#! /usr/bin/env nix-shell</span>
<span class="c">#! nix-shell -i python3 -p python3 python34Packages.pygobject3 libnotify gobjectIntrospection gdk_pixbuf</span></code></pre></div>

<p>The <code>-i</code> parameter to nix-shell tells it which interpreter to use when executing
the script.  Often, it is from one of the dependencies, such as in the above
example.  The <code>-p</code> parameter gives one or more dependencies to be used. After
the above lines follows the script (shamelessly borrowed from the
<a href="https://wiki.archlinux.org/index.php/Desktop_notifications#Usage_in_programming">ArchWiki</a>): </p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#! /usr/bin/env nix-shell</span>
<span class="c">#! nix-shell -i python3 -p python3 python34Packages.pygobject3 libnotify gobjectIntrospection gdk_pixbuf</span>

<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">Notify</span>
<span class="n">Notify</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">)</span>
<span class="n">Hello</span><span class="o">=</span><span class="n">Notify</span><span class="o">.</span><span class="n">Notification</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">,</span><span class="s">&quot;This is an example notification.&quot;</span><span class="p">,</span><span class="s">&quot;dialog-information&quot;</span><span class="p">)</span>
<span class="n">Hello</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>

<p>But its usefulness isn’t limited to just writing scripts interpreted by one of the
declared dependencies.  I needed to write a wrapper for some NodeJS scripts I
had installed in the node_modules directory of a project I am working on.  I
didn’t want Node installed globally, so I did this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/run/current-system/sw/bin/env nix-shell</span>
<span class="c">#!nix-shell -i bash -p nodejs</span>

<span class="nb">readonly </span><span class="nv">BIN_DIR</span><span class="o">=</span><span class="s2">&quot;$(cd -P &quot;</span><span class="k">$(</span>dirname <span class="s2">&quot;${BASH_SOURCE[0]}&quot;</span><span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd)&quot;</span>
<span class="nb">readonly </span><span class="nv">CMD</span><span class="o">=</span><span class="s2">&quot;$(basename ${BASH_SOURCE[0]/%-wrapper/})&quot;</span>

<span class="s2">&quot;${BIN_DIR}&quot;</span>/<span class="s2">&quot;${CMD}&quot;</span> <span class="s2">&quot;$@&quot;</span></code></pre></div>

<p>I simply made a symlink for each program in my <code>node_modules/.bin</code> directory to
this file, with the name <code>program-wrapper</code>, for example, <code>tern-wrapper</code> to wrap
<a href="http://ternjs.net/">tern</a>.  Notice my script doesn’t directly call nodejs,
though the underlying script it calls does.</p>

<p>One more example.  I wrote the following script to render this document as I was
writing it to check the way it looked in HTML:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/run/current-system/sw/bin/env nix-shell</span>
<span class="c">#!nix-shell -i bash -p inotifyTools pandoc</span>

<span class="nb">readonly </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;$*&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-lt <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage:  ${0} MARKDOWN_FILE&quot;</span> 2&gt;<span class="p">&amp;</span>1
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> 2&gt;<span class="p">&amp;</span>1
    <span class="nb">echo</span> <span class="s2">&quot;MARKDOWN_FILE must exist before launching.&quot;</span> 2&gt;<span class="p">&amp;</span>1
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;${FILE}&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;${FILE} doesn&#39;t yet exist, create it before launching!&quot;</span> 2&gt;<span class="p">&amp;</span>1
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Assume the extension is .md</span>
<span class="nb">readonly </span><span class="nv">OUTPUT</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;${FILE}&quot;</span> <span class="s2">&quot;.md&quot;</span><span class="k">)</span>.html

<span class="nb">echo</span> <span class="s2">&quot;Press Control-C to quit watching for changes on ${FILE}.&quot;</span>
<span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    inotifywait -q -e modify <span class="s2">&quot;${FILE}&quot;</span> <span class="o">&amp;&amp;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Updating HTML for ${FILE}&quot;</span> <span class="o">&amp;&amp;</span>
        pandoc -s -f markdown -t html -o <span class="s2">&quot;${OUTPUT}&quot;</span> <span class="s2">&quot;${FILE}&quot;</span>
<span class="k">done</span></code></pre></div>

<p>One last example, where I couldn’t use nix-shell in a shebang line.  I was
playing with <a href="http://jaspervdj.be/hakyll/">Hakyll</a>.  After you use <code>haykll-init</code>
to generate your project structure, all work is done by compiling your own code
(in this case, a <code>site.hs</code> that has an accompanying cabal file.  Since something
similar to the example from the release notes didn’t work, I tried the
following, a variant of what I’ve used in <code>.nix</code> files.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#! /usr/bin/env nix-shell</span>
<span class="c">#! nix-shell -i bash --pure  -p &#39;pkgs.haskellPackages.ghcWithPackages (pkgs: with pkgs; [ hakyll cabal-install ])&#39;</span>

cabal run <span class="nv">$@</span></code></pre></div>

<p>But nix-shell didn’t like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">nafai@shedemei:~/Documents/blog/hakyll/technically
<span class="nv">$ </span>./site-wrapper 
error: syntax error, unexpected <span class="s1">&#39;)&#39;</span>, at <span class="o">(</span>string<span class="o">)</span>:1:66</code></pre></div>

<p>So I had to just make this one a regular shell script:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/run/current-system/sw/bin/bash</span>

nix-shell --pure <span class="se">\</span>
          -p <span class="s2">&quot;pkgs.haskellPackages.ghcWithPackages (pkgs: with pkgs; [ hakyll cabal-install ])&quot;</span> <span class="se">\</span>
          --run <span class="s2">&quot;cabal run $@&quot;</span></code></pre></div>

<p>Anyway, just in these last few days I’ve found interesting ways to use this new
capability.  I hope this gives some examples of how it may be used.  I welcome
any feedback from more experienced Nix users (or comments in general about my
scripting, I’m a little out of practice).</p>

<hr />

<p>I intend to move this content to a blog hosted on my own server once I figure
out a static blog generator to use and all of that associated nonsense.  Putting
this here for now, I will update with a pointer to the final location.</p>

<p>You can find me at <a href="http://twitter.com/travisbhartwell">@travisbhartwell</a> or as
<code>Nafai</code> on <code>#nixos</code> on <a href="http://freenode.net">freenode.net</a>.  Most of my personal
code can now be found on <a href="http://gitlab.com/u/travisbhartwell">Gitlab</a>,
including my shell scripts and my current configurations for
<a href="http://nixos.org">Nix OS</a>, bash, X, <a href="http://i3wm.org">i3</a>, and
<a href="https://github.com/syl20bnr/spacemacs/">Spacemacs</a>.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://iam.travishartwell.net/tags/#Technically Travis" title="Pages tagged Technically Travis" class="tag"><span class="term">Technically Travis</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://iam.travishartwell.net/2015/06/17/nix-shell-shebang/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://iam.travishartwell.net/2012/06/08/a-poem-reflected-back/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://iam.travishartwell.net/2012/06/08/a-poem-reflected-back/" title="A Poem: Reflected Back">A Poem: Reflected Back</a></h3>
      <p>I may be going blindand the darkness encroaching from all sides.But at least with claritynow I see all directly in front of meNo longer t...&hellip; <a href="http://iam.travishartwell.net/2012/06/08/a-poem-reflected-back/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://iam.travishartwell.net/2012/06/07/learning-lessons/" title="Learning Lessons">Learning Lessons</a></h4>
        <span>Published on June 07, 2012</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://iam.travishartwell.net/2012/02/24/provoco-et-non-transverto/" title="No Apologies, or, provoco et non transverto">No Apologies, or, provoco et non transverto</a></h4>
        <span>Published on February 24, 2012</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Travis B. Hartwell. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://iam.travishartwell.net/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://iam.travishartwell.net/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25143601-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


	        

</body>
</html>
